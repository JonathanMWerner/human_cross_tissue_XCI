


Just getting graphs for the XCI-skew project
```{r}
library(VGAM) 
library("gridExtra")
library(dplyr)
library(ggplot2)
library(scales)

```


load the max-powered SNPs for each sample, the statistics dataframe, and the metatdata

```{r}
#load('/home/werner/xchrom_snp_skew/data/GTEx/samples/sample_metadata_with_v8.Rdata')
load("/home/werner/xchrom_snp_skew/data/GTEx/snp_skews/GATK_mod/all_v8_GATK_1_20_2021_update_filt_escape.skew.est.max.genes.Rdata")
load("/home/werner/xchrom_snp_skew/data/GTEx/snp_skews/GATK_mod/v8_final_filtering_skew_and_stats_1_20_21_escape_filt_df.Rdata")

# list.skew.max for ploting unfolded and folded SNP distributions of samples


```



```{r}
folded <- function(x) { apply( cbind(x,1-x), 1, max)} 

```

Making basic binomial plots for the figure 1 graphic. Demonstrating the binomial distribution of XCI

```{r}
#Binomial from 16 cells
par(pty = 's')
#pdf(file = '/home/werner/xchrom_snp_skew/code/graphs/xskew_as_binomial_examples/1_7_21/16_cell_example.pdf', height = 4, width = 4)
p = .5
n = 16
x = 0:n
test = dbinom(x, size = n, prob = p)
plot(x/n, test, xlab = 'Xm / Xm + Xp', ylab = 'probability', type ='b', lwd=5, pch=19, cex.lab = 1.5, cex.axis=1.25)
box(lwd = 3)
#dev.off()


#Binomial from 32 cells
#pdf(file = '/home/werner/xchrom_snp_skew/code/graphs/xskew_as_binomial_examples/1_7_21/32_cell_example.pdf', height = 4, width = 4)
n = 32
x = 0:n
test = dbinom(x, size = n, prob = p)
plot(x/n, test, xlab = 'Xm / Xm + Xp', ylab = 'probability', type ='b', lwd=5, pch=19, cex.lab = 1.5, cex.axis = 1.25)
box(lwd = 3)
#dev.off()

#Binomial from 8 cells
#pdf(file = '/home/werner/xchrom_snp_skew/code/graphs/xskew_as_binomial_examples/1_7_21/8_cell_example.pdf', height = 4, width = 4)
n = 8
x = 0:n
test = dbinom(x, size = n, prob = p)
plot(x/n, test, xlab = 'Xm / Xm + Xp', ylab = 'probability', type ='b', lwd=5, pch=19, cex.lab = 1.5, cex.axis = 1.25)
box(lwd = 3)
#dev.off()

```


Simulate data for a 75% skewed sample, unfolded and folded for the example in Figure 2. Add the folded normal model to it as well

```{r}
mat_skew = .75
pat_skew = 1 - mat_skew
sd_skew = .05

num_genes = 10000

mat_exp = rnorm(n = num_genes, mean = mat_skew, sd = sd_skew)
pat_exp = rnorm(n = num_genes, mean = pat_skew, sd = sd_skew)

hist(mat_exp, xlim = c(0,1), breaks = seq(0,1,.025), freq = F)
hist(pat_exp, xlim = c(0,1), breaks = seq(0,1,.025), freq = F, add = T)

folded_skews = c(mat_exp, pat_exp)
folded_skews = folded(folded_skews)

hist(folded_skews, xlim = c(.5,1))



exp_skew_df = data.frame(skews = c(c(mat_exp, pat_exp), folded_skews), label = c(rep('Unfolded', length = num_genes*2), rep('Folded', length = num_genes*2)))



gg_2 <- ggplot(exp_skew_df[exp_skew_df$label == 'Unfolded', ], aes(x=skews)) + geom_histogram(binwidth = .05, colour="black", fill = "#06e3ff", aes(y=..density..)) + 
  ggtitle('Unfolded skews') +
  scale_x_continuous(limits = c(-0.01, 1.01)) + 
  theme( plot.title=element_text(hjust=.5, size=15), axis.text.y = element_text(size=15), axis.title.y = element_text(size=15),
         axis.text.x = element_text(size=15), axis.title.x = element_text(size=15), 
         panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
         panel.border = element_rect(colour = "black", fill=NA, size=1), panel.background = element_rect(fill = 'white')) +
  xlab('Reference skew')

gg_2 = gg_2 + geom_vline(xintercept = .5, linetype="dashed", color = "red", size=1)
gg_2


gg_2f <- ggplot(exp_skew_df[exp_skew_df$label == 'Folded', ], aes(x=skews)) + geom_histogram(binwidth = .025, colour="black", fill = 'white', aes(y=..density..)) +
  ggtitle('Folded skews') + scale_x_continuous(limits = c(.499, 1.01))+ 
  theme( plot.title=element_text(hjust=.5, size=15), axis.text.y = element_text(size=15), axis.title.y = element_text(size=15),
         axis.text.x = element_text(size=15), axis.title.x = element_text(size=15), 
         panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
         panel.border = element_rect(colour = "black", fill=NA, size=1), panel.background = element_rect(fill = 'white')) + 
  xlab('Folded reference skew')

gg_2f <- gg_2f + stat_function(fun=dfoldnorm, color="red", args=list(mean=mat_skew, sd=sd_skew), size = 1) +
  geom_vline(xintercept = .5, linetype="dashed", color = "red", size=1)
gg_2f

grid.arrange(gg_2, gg_2f, nrow=1)
skewed_gg = arrangeGrob(gg_2, gg_2f, nrow=1)

ggsave(filename='simulated_skewed_folded_example.pdf', device='pdf', path = '/home/werner/xchrom_snp_skew/code/graphs/summary_graphs', units='in', height=5, width=10, dpi=300, 
       plot=skewed_gg, useDingbats=FALSE)


```

Plot unfolded and folded examples of real tissue gene skews for a range of skewed tissues

```{r}
example_skews = c(.55,.65,.75,.85)
limit = .04
i = 4
potential_samples = skew_and_stats_df$sample_index[(skew_and_stats_df$skew >= example_skews[i] - limit) & (skew_and_stats_df$skew <= example_skews[i] + limit) & skew_and_stats_df$num_snps >= 50]
length(potential_samples)

for(j in 1:length(potential_samples)){
  sample_data = list.skew.max[[potential_samples[j]]]
  sample_ref_skews = sample_data$C.1
  est_skew = skew_and_stats_df$skew[skew_and_stats_df$sample_index ==potential_samples[j] ]
  hist(sample_ref_skews, breaks = seq(0,1,.05), xlim = c(0,1), main = sprintf('%i: %1.3f',potential_samples[j], est_skew) )
}
```

```{r}

example_sample_ids = c(4003, 602, 4647, 1368)
example_sample_skews = skew_and_stats_df$skew[match(example_sample_ids,skew_and_stats_df$sample_index)]
example_sample_skews_sd = skew_and_stats_df$skew_sigma[match(example_sample_ids,skew_and_stats_df$sample_index)]

skews = c()
folded_label = c()
sample_label = c()
for(i in 1:length(example_sample_ids)){
  #Get the reference skews
  sample_data = list.skew.max[[example_sample_ids[i]]]
  sample_ref_skews = sample_data$C.1
  skews_add = c(sample_ref_skews, folded(sample_ref_skews))
  skews = c(skews, skews_add)
  folded_label_add = c(rep('Unfolded', length = length(sample_ref_skews)), rep('Folded', length = length(folded(sample_ref_skews))) )
  folded_label = c(folded_label, folded_label_add)
  text = as.character(sprintf('Sample skew: %1.3f', example_sample_skews[i]))
  sample_label = c(sample_label, rep(text, length=length(skews_add)))
}

multi_skew_tissue_df = data.frame(skews = skews, folded_label = folded_label, sample_label = sample_label)
multi_skew_tissue_df


```

```{r}
sample_labels = unique(multi_skew_tissue_df$sample_label)



make_unfolded_ggplot = function(sample_label){

  data_index = multi_skew_tissue_df$folded_label == 'Unfolded' & multi_skew_tissue_df$sample_label == sample_label
  g = ggplot(multi_skew_tissue_df[data_index, ], aes(x = skews)) + geom_histogram(binwidth = .05, colour="black", fill = "#06e3ff") +
    geom_vline(xintercept = .5, linetype="dashed", color = "red", size=1) +
    ggtitle(sample_label) + 
    scale_x_continuous(limits = c(-.01, 1.01))+ 
    theme( plot.title=element_text(hjust=.5, size=15), axis.text.y = element_text(size=15), axis.title.y = element_text(size=15),
           axis.text.x = element_text(size=15), axis.title.x = element_text(size=15), 
           panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
           panel.border = element_rect(colour = "black", fill=NA, size=1), panel.background = element_rect(fill = 'white')) + 
    xlab('Reference skew')
  return(g)
}

g1 = make_unfolded_ggplot(sample_labels[1]) 
g2 = make_unfolded_ggplot(sample_labels[2]) 
g3 = make_unfolded_ggplot(sample_labels[3])  
g4 = make_unfolded_ggplot(sample_labels[4]) 

grid.arrange(g1, g2,g3,g4, nrow=1)
skewed_gg = arrangeGrob(g1, g2,g3,g4, nrow=1)

ggsave(filename='real_sample_unfolded_skew_spread.pdf', device='pdf', path = '/home/werner/xchrom_snp_skew/code/graphs/summary_graphs', units='in', height=5, width=12, dpi=300, 
       plot=skewed_gg, useDingbats=FALSE)





make_folded_ggplot = function(sample_label, mean_skew, sd_skew){

  data_index = multi_skew_tissue_df$folded_label == 'Folded' & multi_skew_tissue_df$sample_label == sample_label
  g = ggplot(multi_skew_tissue_df[data_index, ], aes(x = skews)) + geom_histogram(binwidth = .025, colour="black", fill = 'white', aes(y=..density..)) +
    geom_vline(xintercept = .5, linetype="dashed", color = "red", size=1) +
    ggtitle(sample_label) + 
    scale_x_continuous(limits = c(.499, 1.01))+ 
    stat_function(fun=dfoldnorm, color="red", args=list(mean=mean_skew, sd=sd_skew), size = 1) +
    theme( plot.title=element_text(hjust=.5, size=15), axis.text.y = element_text(size=15), axis.title.y = element_text(size=15),
           axis.text.x = element_text(size=15), axis.title.x = element_text(size=15), 
           panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
           panel.border = element_rect(colour = "black", fill=NA, size=1), panel.background = element_rect(fill = 'white')) + 
    xlab('Folded reference skew')
  return(g)
}


g1_f = make_folded_ggplot(sample_labels[1], example_sample_skews[1], example_sample_skews_sd[1] ) 
g2_f = make_folded_ggplot(sample_labels[2], example_sample_skews[2], example_sample_skews_sd[2] ) 
g3_f = make_folded_ggplot(sample_labels[3], example_sample_skews[3], example_sample_skews_sd[3] )  
g4_f = make_folded_ggplot(sample_labels[4], example_sample_skews[4], example_sample_skews_sd[4] ) 

grid.arrange(g1_f, g2_f,g3_f,g4_f, nrow=1)
skewed_gg = arrangeGrob(g1_f, g2_f,g3_f,g4_f, nrow=1)
ggsave(filename='real_sample_folded_skew_spread.pdf', device='pdf', path = '/home/werner/xchrom_snp_skew/code/graphs/summary_graphs', units='in', height=5, width=12, dpi=300, 
       plot=skewed_gg, useDingbats=FALSE)

```

```{r}
grid.arrange(g1, g2,g3,g4, g1_f, g2_f,g3_f,g4_f, nrow=2)
combined_skewed_gg = arrangeGrob(g1, g2,g3,g4, g1_f, g2_f,g3_f,g4_f, nrow=2)
ggsave(filename='combined_real_sample_skew_spread.pdf', device='pdf', path = '/home/werner/xchrom_snp_skew/code/graphs/summary_graphs', units='in', height=5, width=12, dpi=300, 
       plot=combined_skewed_gg, useDingbats=FALSE)
```













Simulating skew correlations across germ layers if XCi occurs after germ layer specification
Theoretically in our model, skew would be perfectly correlated if XCI occured before

```{r}
num_sims = 1000

p = .5
g_n_1 = 16
g_n_2 =32

g_n_1_sd = sqrt((p*(1-p)) / g_n_1)
g_n_2_sd = sqrt((p*(1-p)) / g_n_2)

test = 1:100/100

y_norm_1 = dnorm(test, mean=p, sd =g_n_1_sd)
y_norm_2 = dnorm(test, mean=p, sd =g_n_2_sd)

plot(test, y_norm_1, col = 'black', pch = 16)
points(test, y_norm_2)



simulate_cross_germ_cor = function(p,num_data, sd_germ1, sd_germ2){
  g_1_samp_skews = rnorm(num_data, mean=p, sd =sd_germ1)
  g_2_samp_skews = rnorm(num_data, mean=p, sd =sd_germ2)
  correlation = cor(g_1_samp_skews, g_2_samp_skews, method = 'pearson')
  return(correlation)
}

num_datapoints = 5000
num_sims = 1000
simulated_corrs = sapply(1:num_sims, function(i) simulate_cross_germ_cor(p, num_datapoints, g_n_1_sd, g_n_2_sd))

hist(simulated_corrs)

g_1_samp_skews = rnorm(num_datapoints, mean=p, sd =g_n_1_sd)
g_2_samp_skews = rnorm(num_datapoints, mean=p, sd =g_n_2_sd)
par(pty = 's')
independent_cor = cor(g_1_samp_skews, g_2_samp_skews, method = 'pearson')
title = sprintf('Correlation: %f', independent_cor)

pdf(file = '/home/werner/xchrom_snp_skew/code/graphs/tiss_tiss_correlations/updated/skew_independent_across_germ_layers.pdf', 
height = 4, width = 4, useDingbats = F)
plot(g_1_samp_skews, g_2_samp_skews, xlim = c(0,1), ylim = c(0,1), 
     main = title, cex = .4, pch = 19, 
     xlab = 'Germ layer 1 skews', ylab = 'Germ layer 2 skews')
dev.off()

#Now fold it and see what happens
g_1_samp_skews =folded(g_1_samp_skews)
g_2_samp_skews =folded(g_2_samp_skews)
independent_cor = cor(g_1_samp_skews, g_2_samp_skews, method = 'pearson')
title = sprintf('Folded independent Correlation: %f', independent_cor)
plot(g_1_samp_skews, g_2_samp_skews, xlim = c(.5,1), ylim = c(.5,1), 
     main = title, cex = .4, pch = 19, 
     xlab = 'Germ layer 1 skews', ylab = 'Germ layer 2 skews')



#Now if XCI occurs before, the skews across germ layers will be dependent on one another

#Get a skew
g_n_x = 16
g_n_x_sd = sqrt((p*(1-p)) / g_n_x)

simulate_dependent_skews = function(p, xci_var, cell_num_1, cell_num_2){
  skew = rnorm(1, mean=p, sd =xci_var)
  g_n_1_sd_x = sqrt((skew*(1-skew)) / cell_num_1)
  g_n_2_sd_x = sqrt((skew*(1-skew)) / cell_num_2)
  
  g_1_samp_skews_x = rnorm(1, mean=skew, sd =g_n_1_sd_x )
  g_2_samp_skews_x = rnorm(1, mean=skew, sd =g_n_2_sd_x )
  return(list(g_1_samp_skews_x, g_2_samp_skews_x))
}


dependent_skews = lapply(1:num_datapoints, function(i) simulate_dependent_skews(p, g_n_x_sd, g_n_1, g_n_2 )  )

dependent_skews_1 = sapply(dependent_skews, '[[', 1)
dependent_skews_2 = sapply(dependent_skews, '[[', 2)
dependent_cor = cor(dependent_skews_1, dependent_skews_2, method = 'pearson')
par(pty = 's')
title = sprintf('Correlation: %f', dependent_cor)
pdf(file = '/home/werner/xchrom_snp_skew/code/graphs/tiss_tiss_correlations/updated/skew_dependent_across_germ_layers.pdf', 
height = 4, width = 4, useDingbats = F)
plot(dependent_skews_1,dependent_skews_2, xlim = c(0,1), ylim = c(0,1), 
     main = title, cex = .4, pch = 19,
     xlab = 'Germ layer 1 skews', ylab = 'Germ layer 2 skews')
dev.off()

#Now fold it and see what happens
dependent_skews_1 = folded(dependent_skews_1)
dependent_skews_2 = folded(dependent_skews_2)
dependent_cor = cor(dependent_skews_1, dependent_skews_2, method = 'pearson')
title = sprintf('Folded dependent Correlation: %f', dependent_cor)
plot(dependent_skews_1,dependent_skews_2, xlim = c(.5,1), ylim = c(.5,1), 
     main = title, cex = .4, pch = 19,
     xlab = 'Germ layer 1 skews', ylab = 'Germ layer 2 skews')



```

Plot the simulated data but folded and in the same 2D density estimate as the real data

```{r}
par(pty = 's')
title = sprintf('Folded independent Correlation: %f', independent_cor)
plot(g_1_samp_skews, g_2_samp_skews, xlim = c(.5,1), ylim = c(.5,1), 
     main = title, cex = .4, pch = 19, 
     xlab = 'Germ layer 1 skews', ylab = 'Germ layer 2 skews')


germ_independent_skew_df = data.frame(g1_skews =g_1_samp_skews, g2_skews = g_2_samp_skews )
p = ggplot(germ_independent_skew_df, aes(x=g1_skews, y=g2_skews) ) +
stat_density_2d(aes(fill = ..density..), geom = "raster", contour = FALSE, n = 200) +
scale_fill_distiller(palette= "Spectral", direction=-1) +
ylim(.5,1) + xlim(.5,1) + coord_fixed() +
ylab('Germ layer 2 skews') + xlab('Germ layer 1 skews') + ggtitle('Skew is independent across germ layers') +
theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
     panel.border = element_rect(colour = "black", fill=NA, size=1),
     plot.title = element_text(hjust = .5), 
     axis.title.y = element_text(size =12), axis.text.y = element_text(size = 12), 
     axis.title.x = element_text(size = 12), axis.text.x = element_text(size = 12),
     panel.background = element_rect(fill = 'white'))

print(p)
ggsave(filename = 'simulated_independent_skew_corr_across_germlayers.pdf', device = 'pdf', plot = p, 
       path = '/home/werner/xchrom_snp_skew/code/graphs/tiss_tiss_correlations/updated/', dpi = 300, height = 4, width = 4, useDingbats = FALSE )


title = sprintf('Folded dependent Correlation: %f', dependent_cor)
plot(dependent_skews_1,dependent_skews_2, xlim = c(.5,1), ylim = c(.5,1), 
     main = title, cex = .4, pch = 19,
     xlab = 'Germ layer 1 skews', ylab = 'Germ layer 2 skews')

germ_dependent_skew_df = data.frame(g1_skews =dependent_skews_1, g2_skews =dependent_skews_2)
p = ggplot(germ_dependent_skew_df, aes(x=g1_skews, y=g2_skews) ) +
stat_density_2d(aes(fill = ..density..), geom = "raster", contour = FALSE, n = 200) +
scale_fill_distiller(palette= "Spectral", direction=-1) +
ylim(.5,1) + xlim(.5,1) + coord_fixed() +
ylab('Germ layer 2 skews') + xlab('Germ layer 1 skews') + ggtitle('Skew is dependent across germ layers') +
theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
     panel.border = element_rect(colour = "black", fill=NA, size=1),
     plot.title = element_text(hjust = .5), 
     axis.title.y = element_text(size =12), axis.text.y = element_text(size = 12), 
     axis.title.x = element_text(size = 12), axis.text.x = element_text(size = 12),
     panel.background = element_rect(fill = 'white'))
print(p)
ggsave(filename = 'simulated_dependent_skew_corr_across_germlayers.pdf', device = 'pdf', plot = p, 
       path = '/home/werner/xchrom_snp_skew/code/graphs/tiss_tiss_correlations/updated/', dpi = 300, height = 4, width = 4, useDingbats = FALSE )

```






```{r}

skew = .75
n_1 = 16
n_2 = 64
par(pty = 's')
#pdf(file = '/home/werner/xchrom_snp_skew/code/graphs/xskew_as_binomial_examples/1_7_21/16_cell_centered_at_75.pdf', height = 4, width = 4, useDingbats = F)
skews_1 = 0:n_1
binom_1 = dbinom(skews_1, size = n_1, prob = skew )
plot(skews_1/n_1, binom_1, type ='b', lwd=5, pch=19, cex.lab = 1.5, cex.axis = 1.25, xlim = c(.5, 1))
abline(v = .75, col = 'red')
#dev.off()

par(pty = 's')
#pdf(file = '/home/werner/xchrom_snp_skew/code/graphs/xskew_as_binomial_examples/1_7_21/64_cell_centered_at_75.pdf', height = 4, width = 4, useDingbats = F)
skews_2 = 0:n_2
binom_2 = dbinom(skews_2, size = n_2, prob = skew )
plot(skews_2/n_2, binom_2, type ='b', lwd=5, pch=19, cex.lab = 1.5, cex.axis = 1.25, xlim = c(.5, 1))
abline(v = .75, col = 'red')
#dev.off()
```










```{r}

head(skew_and_stats_df)
dim(skew_and_stats_df)
```
```{r}
library(scales)

```

Calculate the number of donors that have a skewed tissue
Don't know if i want to use it though
```{r}
donors = names(table(skew_and_stats_df$donor))
skew_present = vector(mode = 'numeric', length = length(donors))

for(i in 1:length(donors)){
  
  #Get the skews for that donor
  skews = skew_and_stats_df$skew[skew_and_stats_df$donor == donors[i]]
  skew_present[i] = as.numeric(sum(skews >= .8) >= 1)

}



donor_skewed_df = data.frame(label= c('Skewed tissue present', 'Skewed tissue not present'), skew_present =c(sum(skew_present), sum(!skew_present)))

bar = ggplot(donor_skewed_df, aes(x="", y=skew_present, fill=label)) +
  geom_bar(width = 1, stat = "identity") 
bar + coord_polar("y", start=0) 


```





```{r}
dim(skew_and_stats_df)

hist(skew_and_stats_df$skew, prob=TRUE, main=sprintf('Skew estimates across all tissues (n=%i)',dim(skew_and_stats_df)[1] ), xlab='Estimated XCI-skew', breaks=32)
lines(density(skew_and_stats_df$skew, cut=0), lwd=2)

hist(skew_and_stats_df$skew_sigma, prob=TRUE, main=sprintf('Fited variances across all tissues (n=%i)',dim(skew_and_stats_df)[1] ), xlab='Estimated variance')
lines(density(skew_and_stats_df$skew, cut=0), lwd=2)


ggplot(skew_and_stats_df, aes(x=skew)) + geom_histogram(binwidth = .0075, color = 'white', fill="black") + 
  ggtitle('Estimated XCI skews for all of GTEx') + ylab('Number of tissue samples') +
  scale_x_continuous(breaks = c(.5, .6, .7, .8, .9, 1), limits = c(.49, 1.01)) +
  theme( panel.grid.major = element_blank(), panel.grid.minor = element_blank(), plot.title=element_text(hjust=.5, size=15), 
         axis.text.y = element_text(size=15), axis.title.y = element_text(size=15), 
         axis.text.x = element_text(size=15), axis.title.x = element_text(size=15),
         panel.border = element_rect(colour = "black", fill=NA, size=1), panel.background = element_rect(fill = 'white')) + xlab('Estimated XCI skew - Folded normal model')

ggsave(filename='all_gtex_estimated_skew_distribution.pdf', device='pdf', path = '/home/werner/xchrom_snp_skew/code/graphs/summary_graphs', units='in', height=4, width=5, dpi=300, useDingbats=FALSE)



```
```{r}
sample_meta

```



```{r}
skew_and_stats_df

```

```{r}
length(names(table(skew_and_stats_df$donor)))

```


```{r}

plot_donor_tissue_skews = function(ind_1, ind_2, donor_order){

  temp_donors  = donor_order[ind_1:ind_2]
  temp_skew_and_stats_df = skew_and_stats_df[ skew_and_stats_df$donor %in% temp_donors, ]
  temp_skew_and_stats_df$donor = factor(temp_skew_and_stats_df$donor, levels = donor_order[ind_1:ind_2])
  g = ggplot(temp_skew_and_stats_df, aes(x = donor, y = skew)) + geom_boxplot() +
    xlab('Donors') + ylab('Tissue skews') + ylim(.5, 1) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
          panel.border = element_rect(colour = "black", fill=NA, size=1), 
          panel.background = element_rect(fill = 'white'),
          axis.text.x = element_blank(), axis.ticks.x = element_blank(), 
          axis.text.y = element_text(size = 15))
  plot(g)
  
}

ordered_df = skew_and_stats_df %>% group_by(donor) %>% summarise_at(vars(skew), funs(median(., na.rm=TRUE)))
ordered_df = ordered_df[order(ordered_df$skew), ]
ordered_levels = as.character(ordered_df$donor)



plot_donor_tissue_skews(1, 100,ordered_levels)
plot_donor_tissue_skews(101, 200,ordered_levels)
plot_donor_tissue_skews(202, 300,ordered_levels)
plot_donor_tissue_skews(301, 334,ordered_levels)

```







```{r}
donors = as.character(unique(sample_meta$V9))
tiss_num = vector(mode='numeric', length = length(donors))
for(i in 1: length(donors)){
  tiss_num[i] = length(which(sample_meta$V9 %in% donors[i]))
}

donor_tiss_df = data.frame(donor = donors, num_tissues = tiss_num)
donor_tiss_df = donor_tiss_df[order(donor_tiss_df$num_tissues, decreasing=TRUE), ]
donor_tiss_df = mutate(donor_tiss_df, donor = factor(donor, donor))

max_num_tiss = max(donor_tiss_df$num_tissues)
num_donors = dim(donor_tiss_df)[1]


ecdf_vec = vector(mode='numeric', length=max_num_tiss)
for(i in 1:max_num_tiss){
  ecdf_vec[i] = sum(donor_tiss_df$num_tissues >= i) / num_donors 
}

t = 1:max_num_tiss
tiss_ecdf_df = data.frame(num_tissue = t, ecdf = ecdf_vec)




#pdf(file='graphs/summary_graphs/cdf_tissues_per_donor.pdf', height=10, width=11)
ggplot(tiss_ecdf_df, aes(x=num_tissue, y=ecdf)) + geom_point(alpha=.5, size=2.5) + geom_line() + ylab('Percent of donors') + xlab('Number of donated tissues') + ggtitle('Number of donated tissues per donor') + theme(plot.title=element_text(hjust=.5), axis.text.y = element_text(size=11),axis.text.x = element_text(size=11) ) 
#dev.off()



```



```{r}


tissues = unique(sample_meta$V4)
donor_num = vector(mode='numeric', length=length(tissues))
for(i in 1:length(tissues)){
  donor_num[i] = length(unique(sample_meta$V9[which(sample_meta$V4 %in% tissues[i])]))
  
}

tissue_donor_df = data.frame(tissue = tissues, num_donors = donor_num)
tissue_donor_df = tissue_donor_df[order(tissue_donor_df$num_donors, decreasing=TRUE), ]
tissue_donor_df = mutate(tissue_donor_df, tissue = factor(tissue,tissue))


#pdf(file='graphs/summary_graphs/num_donor_per_tiss.pdf', height=10, width=11)
ggplot(tissue_donor_df , aes(x=tissue, y=num_donors)) + geom_bar(stat='identity', color='white', fill='black') + ylab('Number of donors') + xlab('Tissue (n=51)') + ggtitle('Number of donors per tissue') + 
  theme(legend.position="none",axis.text.x = element_text(angle = 45, hjust = 1, size =6, face='bold'), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.ticks = element_blank(),plot.title=element_text(hjust=.5), axis.text.y = element_text(size=11))
#dev.off()

```


```{r}
dim(skew_and_stats_df)

```




Ordered plot of number of max-powered SNPs used per sample
```{r}
snps = skew_and_stats_df$num_snps
sample_num = skew_and_stats_df$sample_index

num_samples = dim(skew_and_stats_df)[1]

graph_1_df = data.frame(num_snps = snps, sample_num = sample_num)
graph_1_df = graph_1_df[order(graph_1_df$num_snps, decreasing=FALSE), ]
graph_1_df = mutate(graph_1_df, sample_num = factor(sample_num, sample_num))


#pdf(file='graphs/summary_graphs/num_max_snps_per_tiss.pdf', height=10, width=11)
ggplot(graph_1_df , aes(x=sample_num, y=num_snps)) + geom_point() + ylab('Number of max-powered SNPs') + ggtitle('Number of max SNPs per sample') + xlab(sprintf('Samples (n=%i)', num_samples)) + geom_hline(yintercept = 10, color = 'red') + 
  theme(legend.position="none",axis.text.x = element_blank(), axis.title.x = element_text(size=14),
        axis.text.y = element_text(size=12), axis.title.y = element_text(size=14),
        panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.ticks.x=element_blank(), plot.title=element_text(hjust=.5, size=14), 
        panel.border = element_rect(colour = "black", fill=NA, size=1), panel.background = element_rect(fill = 'white')) + coord_cartesian(clip='off')
#dev.off()
ggsave(filename='num_max_snps_per_sample.pdf', device='pdf', path = '/home/werner/xchrom_snp_skew/code/graphs/summary_graphs', units='in', height=5, width=7, dpi=300, useDingbats = FALSE)





```




```{r}
dim(skew_and_stats_df)

```



folded and unfolded examples of SNP distributions for a skewed and non_skewed sample

```{r}
#grab the samples
skew_and_stats_df$sample_index[skew_and_stats_df$skew <= .55 & skew_and_stats_df$num_snps == 50]
```

```{r}
#grab the samples
skew_and_stats_df$sample_index[skew_and_stats_df$skew >= .75 & skew_and_stats_df$num_snps == 50]
```




```{r}
#original non skew Good examples: 57
#original skew Good examples: 571



par(mfrow=c(2,2))
snp_ratios = list.skew.max[[3801]]$C.1
num_snps = length(snp_ratios)

title_1 = sprintf('Unfolded non-skewed sample n=%g', num_snps)
title_2 = sprintf('Folded', num_snps)
hist(snp_ratios, xlim=c(0,1), main=title_1, breaks = 32)
hist(folded(snp_ratios), xlim=c(.5,1), main=title_2, breaks = 32)


snp_ratios = list.skew.max[[4536]]$C.1
num_snps = length(snp_ratios)

title_1 = sprintf('Unfolded skewed sample n=%g', num_snps)
title_2 = sprintf('Folded', num_snps)
hist(snp_ratios, xlim=c(0,1), main=title_1, breaks = 32)
hist(folded(snp_ratios), xlim=c(.5,1), main=title_2, breaks = 32)



```

```{r}
folded_examples_df = data.frame(non_skewed = list.skew.max[[3801]]$C.1, skewed =list.skew.max[[4536]]$C.1 )
folded_examples_df
```




```{r}

mean = skew_and_stats_df$skew[skew_and_stats_df$sample_index == 3801]
sd = skew_and_stats_df$skew_sigma[skew_and_stats_df$sample_index == 3801]

gg_1 <- ggplot(folded_examples_df, aes(x=non_skewed)) + geom_histogram(binwidth = .05, colour="black", fill = 'white') + 
  ggtitle('Unfolded non-skewed') + 
  scale_x_continuous(limits = c(0, 1)) +
  theme( plot.title=element_text(hjust=.5, size=15), axis.text.y = element_text(size=15), axis.title.y = element_text(size=15), 
         axis.text.x = element_text(size=15), axis.title.x = element_text(size=15), 
         panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
         panel.border = element_rect(colour = "black", fill=NA, size=1), panel.background = element_rect(fill = 'white')) +
  xlab('Reference skew')
gg_1 = gg_1 + geom_vline(xintercept = .5, linetype="dashed", color = "red", size=.5)


gg_1f <- ggplot(folded_examples_df, aes(x=folded(non_skewed))) + geom_histogram(binwidth = .025, colour="black", fill = 'white', aes(y=..density..)) + ggtitle(sprintf('Folded estimated XCI-skew = %g', mean)) + scale_x_continuous(limits = c(.49, 1)) + 
  theme( plot.title=element_text(hjust=.5, size=15), axis.text.y = element_text(size=15), axis.title.y = element_text(size=15) ,
         axis.text.x = element_text(size=15), axis.title.x = element_text(size=15), 
         panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
         panel.border = element_rect(colour = "black", fill=NA, size=1), panel.background = element_rect(fill = 'white')) + xlab('Folded skew')

gg_1f <- gg_1f + stat_function(fun=dfoldnorm, color="red", args=list(mean=mean, sd=sd)) +
  geom_vline(xintercept = .5, linetype="dashed", color = "red", size=.5)

grid.arrange(gg_1, gg_1f, nrow=1)
non_skewed_gg = arrangeGrob(gg_1, gg_1f, nrow=1)

ggsave(filename='non_skewed_folded_example_v4.pdf', device='pdf', path = '/home/werner/xchrom_snp_skew/code/graphs/summary_graphs', units='in', height=5, width=10, dpi=300, 
       plot=non_skewed_gg, useDingbats=FALSE)


mean = skew_and_stats_df$skew[skew_and_stats_df$sample_index == 4536]
sd = skew_and_stats_df$skew_sigma[skew_and_stats_df$sample_index == 4536]

gg_2 <- ggplot(folded_examples_df, aes(x=skewed)) + geom_histogram(binwidth = .05, colour="black", fill = 'white') + 
  ggtitle('Unfolded skewed') +
  scale_x_continuous(limits = c(0, 1)) + 
  theme( plot.title=element_text(hjust=.5, size=15), axis.text.y = element_text(size=15), axis.title.y = element_text(size=15),
         axis.text.x = element_text(size=15), axis.title.x = element_text(size=15), 
         panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
         panel.border = element_rect(colour = "black", fill=NA, size=1), panel.background = element_rect(fill = 'white')) +
  xlab('Reference skew')

gg_2 = gg_2 + geom_vline(xintercept = .5, linetype="dashed", color = "red", size=.5)

gg_2f <- ggplot(folded_examples_df, aes(x=folded(skewed))) + geom_histogram(binwidth = .025, colour="black", fill = 'white', aes(y=..density..)) +
  ggtitle(sprintf('Folded estimated XCI-skew = %g', mean)) + scale_x_continuous(limits = c(.49, 1))+ 
  theme( plot.title=element_text(hjust=.5, size=15), axis.text.y = element_text(size=15), axis.title.y = element_text(size=15),
         axis.text.x = element_text(size=15), axis.title.x = element_text(size=15), 
         panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
         panel.border = element_rect(colour = "black", fill=NA, size=1), panel.background = element_rect(fill = 'white')) + 
  xlab('Folded skew')

gg_2f <- gg_2f + stat_function(fun=dfoldnorm, color="red", args=list(mean=mean, sd=sd)) +
  geom_vline(xintercept = .5, linetype="dashed", color = "red", size=.5)

grid.arrange(gg_2, gg_2f, nrow=1)
skewed_gg = arrangeGrob(gg_2, gg_2f, nrow=1)
ggsave(filename='skewed_folded_example_v4.pdf', device='pdf', path = '/home/werner/xchrom_snp_skew/code/graphs/summary_graphs', units='in', height=5, width=10, dpi=300, 
       plot=skewed_gg, useDingbats=FALSE)


grid.arrange(gg_1, gg_1f, gg_2, gg_2f, nrow=2)
combined_gg = arrangeGrob(gg_1, gg_1f, gg_2, gg_2f, nrow=2)
ggsave(filename='combined_folded_example_v4.pdf', device='pdf', path = '/home/werner/xchrom_snp_skew/code/graphs/summary_graphs', units='in', height=10, width=10, dpi=300, 
       plot=combined_gg, useDingbats=FALSE)
```



















